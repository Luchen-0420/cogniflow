# AI 主动辅助功能

## 📋 功能概述

AI 主动辅助功能是一个智能助手，能够自动检测用户输入的任务中包含特定关键词（如"写一篇"、"调研"等），在用户无感知的情况下，调用大模型和联网搜索能力，对用户的任务进行主动辅助。

## ✨ 主要特性

1. **自动检测关键词**：系统会自动检测用户输入中的关键词，判断是否需要提供辅助
2. **后台静默执行**：辅助功能在后台执行，不会打断用户的操作流程
3. **智能搜索**：自动调用 GLM 网络搜索 API，获取相关信息
4. **AI 总结**：使用大模型对搜索结果进行总结，生成有价值的参考信息
5. **子卡片补充**：将辅助信息以子卡片的形式自动添加到主卡片中

## 🎯 触发关键词

当用户输入包含以下关键词时，系统会自动触发 AI 辅助功能：

- **写作相关**：写一篇、写、撰写、创作
- **调研相关**：调研、研究、了解、分析
- **学习相关**：学习、复习、总结、整理
- **规划相关**：准备、制定、规划、设计
- **开发相关**：开发、实现、评估、讨论、探讨

## 🔧 配置要求

### 环境变量配置

在 `.env` 文件中添加以下配置（推荐使用 `ZHIPUAI_*` 命名，系统向下兼容旧的 `VITE_GLM_*` 变量）：

```env
# 智谱（GLM）API 配置（必需）
VITE_ZHIPUAI_API_KEY=your_api_key_here
VITE_ZHIPUAI_MODEL=glm-4-flash
# 兼容旧变量：VITE_GLM_API_KEY / VITE_GLM_MODEL

# 智谱网络搜索 API 配置（AI 主动辅助功能需要）
# 搜索引擎选项：
# - search_std：智谱基础版搜索引擎（推荐）
# - search_pro：智谱高阶版搜索引擎
# - search_pro_sogou：搜狗搜索
# - search_pro_quark：夸克搜索
VITE_ZHIPUAI_SEARCH_ENGINE=search_std
# 兼容旧变量：VITE_GLM_SEARCH_ENGINE
```

### 获取 API Key

1. 访问 [智谱AI开放平台](https://open.bigmodel.cn/)
2. 注册/登录账号
3. 进入 **控制台** → **API 密钥管理**
4. 创建新的 API Key
5. 复制 API Key 到 `.env` 文件

## 📖 使用示例

### 示例 1：写作任务

**输入：**
```
今天要写一篇关于React Hooks的文章
```

**系统行为：**
1. 检测到关键词"写一篇"
2. 后台搜索"React Hooks"相关信息
3. 使用 AI 总结搜索结果
4. 生成子卡片，包含：
   - 💡 相关知识点（如：useState、useEffect 的使用方法）
   - 📚 参考信息摘要
   - 🔗 相关链接（包含来源信息）

### 示例 2：调研任务

**输入：**
```
调研一下最新的AI技术趋势
```

**系统行为：**
1. 检测到关键词"调研"
2. 后台搜索"AI技术趋势"相关信息
3. 使用 AI 总结搜索结果
4. 生成子卡片，包含：
   - 💡 相关知识点（如：大模型、多模态AI等）
   - 📚 参考信息摘要
   - 🔗 相关链接（包含来源信息）

### 示例 3：学习任务

**输入：**
```
学习一下TypeScript的高级特性
```

**系统行为：**
1. 检测到关键词"学习"
2. 后台搜索"TypeScript高级特性"相关信息
3. 使用 AI 总结搜索结果
4. 生成子卡片，包含相关知识点和参考信息

## 🎨 子卡片格式

AI 辅助功能生成的子卡片包含以下类型：

1. **知识点卡片**（💡）
   - 格式：`💡 [知识点内容]`
   - 包含 3-5 个关键知识点

2. **参考信息卡片**（📚）
   - 格式：`📚 参考信息：[摘要内容]`
   - 包含 100-200 字的参考信息摘要

3. **来源链接卡片**（🔗）
   - 格式：`🔗 [标题] ([来源]) - [链接]`
   - 包含最多 3 个相关链接

## 🔍 工作原理

1. **关键词检测**：系统检测用户输入中是否包含触发关键词
2. **关键词提取**：从任务文本中提取搜索关键词
3. **网络搜索**：调用智谱（GLM）网络搜索 API 获取相关信息
4. **AI 总结**：使用大模型对搜索结果进行总结和分析
5. **子卡片生成**：将辅助信息格式化为子卡片
6. **自动添加**：将子卡片添加到主卡片的 `sub_items` 字段中

## ⚙️ 技术实现

### 核心文件

- `src/utils/webSearch.ts`：智谱（GLM）网络搜索 API 封装
- `src/utils/aiAssist.ts`：AI 辅助服务核心逻辑
- `src/components/items/QuickInput.tsx`：输入组件集成

### API 调用流程

```
用户输入 → 关键词检测 → 提取搜索关键词 → 智谱（GLM）网络搜索 API
                                                      ↓
子卡片生成 ← AI 总结 ← 搜索结果处理 ← 搜索响应
```

## 🛠️ 故障排除

### 问题 1：辅助功能未触发

**可能原因：**
- 输入文本中不包含触发关键词
- 环境变量未正确配置

**解决方案：**
1. 确认输入包含触发关键词（如"写一篇"、"调研"等）
2. 检查 `.env` 文件中的 `VITE_ZHIPUAI_API_KEY`（或兼容的 `VITE_GLM_API_KEY`）和 `VITE_ZHIPUAI_SEARCH_ENGINE` 配置
3. 重启开发服务器

### 问题 2：搜索失败

**可能原因：**
- API Key 无效或过期
- 网络连接问题
- 搜索 API 配额用尽

**解决方案：**
1. 检查 API Key 是否有效
2. 检查网络连接
3. 查看智谱AI控制台的 API 使用情况
4. 系统会在搜索失败时使用 AI 知识库作为备用方案

### 问题 3：子卡片未添加

**可能原因：**
- 数据库更新失败
- 卡片 ID 不存在

**解决方案：**
1. 查看浏览器控制台的错误日志
2. 检查数据库连接
3. 确认卡片创建成功

## 📝 注意事项

1. **静默执行**：辅助功能在后台静默执行，不会显示进度提示，避免打扰用户
2. **异步处理**：辅助功能是异步执行的，不会阻塞主流程
3. **失败处理**：如果搜索或 AI 处理失败，系统会静默处理，不会影响主卡片创建
4. **API 配额**：注意监控 API 使用量，避免超出配额

## 🔮 未来计划

- [ ] 支持更多触发关键词
- [ ] 支持自定义触发规则
- [ ] 优化搜索结果的准确性
- [ ] 支持多语言搜索
- [ ] 添加辅助功能的开关设置

## 📚 相关文档

- [智谱（GLM）API 配置指南](../configuration/GLM_SETUP.md)
- [环境变量配置](../configuration/ENVIRONMENT.md)
- [智能模板功能](./SMART_TEMPLATES.md)

