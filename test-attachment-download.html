<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>附件下载测试</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; }
        img { max-width: 500px; border: 1px solid #ccc; }
        .error { color: red; }
        .success { color: green; }
        button { margin: 5px; padding: 10px; }
    </style>
</head>
<body>
    <h1>附件下载测试</h1>
    
    <div class="test-section">
        <h2>1. 获取 Token</h2>
        <button onclick="getToken()">获取当前 Token</button>
        <div id="token-display"></div>
    </div>

    <div class="test-section">
        <h2>2. 测试附件列表</h2>
        <button onclick="testAttachmentList()">获取附件列表</button>
        <div id="attachment-list"></div>
    </div>

    <div class="test-section">
        <h2>3. 测试图片加载</h2>
        <p>附件 ID: <input type="text" id="attachment-id" value="600acec1-1a7e-4e9d-980c-b480981f43ea" style="width: 400px"></p>
        <button onclick="testImageLoad()">加载图片</button>
        <div id="image-container"></div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3001/api';

        function getToken() {
            const token = localStorage.getItem('cogniflow_auth_token');
            const display = document.getElementById('token-display');
            if (token) {
                display.innerHTML = `<p class="success">Token: ${token.substring(0, 50)}...</p>`;
            } else {
                display.innerHTML = '<p class="error">未找到 Token，请先登录</p>';
            }
        }

        async function testAttachmentList() {
            const token = localStorage.getItem('cogniflow_auth_token');
            const display = document.getElementById('attachment-list');
            
            if (!token) {
                display.innerHTML = '<p class="error">请先获取 Token</p>';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/attachments/item/254591ca-8006-4d47-a2b5-80668ec17c1d`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const attachments = await response.json();
                display.innerHTML = `<p class="success">找到 ${attachments.length} 个附件:</p><pre>${JSON.stringify(attachments, null, 2)}</pre>`;
            } catch (error) {
                display.innerHTML = `<p class="error">错误: ${error.message}</p>`;
            }
        }

        function testImageLoad() {
            const token = localStorage.getItem('cogniflow_auth_token');
            const attachmentId = document.getElementById('attachment-id').value;
            const container = document.getElementById('image-container');
            
            if (!token) {
                container.innerHTML = '<p class="error">请先获取 Token</p>';
                return;
            }

            // 测试1: 使用 query 参数
            const urlWithQuery = `${API_BASE_URL}/attachments/${attachmentId}/file?token=${token}`;
            
            // 测试2: 使用 fetch + blob
            const urlWithHeader = `${API_BASE_URL}/attachments/${attachmentId}/file`;

            container.innerHTML = `
                <h3>方法1: URL + Query Token</h3>
                <p>URL: ${urlWithQuery.substring(0, 80)}...</p>
                <img src="${urlWithQuery}" 
                     onload="console.log('✅ 图片加载成功 (query)')" 
                     onerror="console.error('❌ 图片加载失败 (query)')">
                
                <h3>方法2: Fetch + Authorization Header</h3>
                <p>URL: ${urlWithHeader}</p>
                <div id="fetch-result">加载中...</div>
            `;

            // 使用 fetch 测试
            fetch(urlWithHeader, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                console.log('Fetch response:', response.status, response.statusText);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.blob();
            })
            .then(blob => {
                const url = URL.createObjectURL(blob);
                document.getElementById('fetch-result').innerHTML = `
                    <p class="success">✅ Fetch 成功</p>
                    <img src="${url}" onload="console.log('✅ Blob 图片加载成功')">
                `;
            })
            .catch(error => {
                document.getElementById('fetch-result').innerHTML = `
                    <p class="error">❌ Fetch 失败: ${error.message}</p>
                `;
            });
        }

        // 页面加载时自动获取 token
        window.onload = () => {
            getToken();
        };
    </script>
</body>
</html>
